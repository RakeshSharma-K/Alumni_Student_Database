<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alumni Dashboard - Alumni Student Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>

</head>
<body>
   
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">Alumni Student Management System</div>
            <div class="nav-buttons">
                <a href="index.html" class="btn btn-outline">Logout</a>
            </div>
        </div>
    </nav>

    
    <div class="dashboard">
        <div class="container">
            <div class="dashboard-header">
    

                <h1>Alumni Dashboard</h1>
                <h2 id="welcomeHeader" class="welcome-text"></h2>

                <p>Welcome back! Manage your contributions and mentorship activities</p>
            </div>

            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Students Mentored</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$0K</div>
                    <div class="stat-label">Funds Contributed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Events Hosted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Opportunities Created</div>
                </div>
            </div>

            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon">ðŸ‘¥</div>
                    <h3>Alumni Network</h3>
                    <p>Browse and connect with fellow alumni from different graduating classes and industries</p>
                    <a href="#" class="btn btn-secondary">View Profiles</a>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ðŸ’°</div>
                    <h3>Provide Scholarships</h3>
                    <p>Create and fund scholarship opportunities for deserving students in need</p>
                    <a href="#" class="btn btn-secondary">Create Scholarship</a>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ðŸ’¼</div>
                    <h3>Offer Internships</h3>
                    <p>Post internship opportunities at your company for talented students</p>
                    <a href="post-internship.html" class="btn btn-secondary">Post Internship</a>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ðŸŽ¥</div>
                    <h3>Mentor Students</h3>
                    <p>Host video sessions and provide career guidance to students seeking mentorship</p>
                    <a href="#" class="btn btn-secondary">Schedule Session</a>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ðŸŽŠ</div>
                    <h3>Host Events</h3>
                    <p>Organize networking events, workshops, and seminars for student engagement</p>
                    <a href="#" class="btn btn-secondary">Create Event</a>
                </div>

                <div class="dashboard-card">
                    <div class="card-icon">ðŸ“Š</div>
                    <h3>Impact Analytics</h3>
                    <p>Track your contributions and see the impact you're making on students' lives</p>
                    <a href="#" class="btn btn-secondary">View Analytics</a>
                </div>
            </div>
        </div>
    </div>
    
<div class="chat-icon" id="chatIcon">ðŸ’¬</div>

<div class="chat-main-container">
    <!-- User List Sidebar -->
    <div class="user-list-sidebar">
        <h3>Chat</h3>
        <ul id="userList" class="user-list">
            <li class="user-list-placeholder">Loading users...</li>
        </ul>
    </div>

    <!-- Chat Message Box -->
    <div id="chatSidebar" class="chat-sidebar">
        <div class="chat-header">
            <span id="chatRecipientName">Select a user to chat</span>
            <button id="closeChat" class="close-chat">&times;</button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <p class="chat-placeholder">Your messages will appear here.</p>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message..." disabled/>
            <button id="sendBtn" class="btn-send" disabled>Send</button>
        </div>
    </div>
</div>


<script>
   

    document.getElementById('chatIcon').addEventListener('click', () => {
    chatSidebarEl.classList.toggle('open');
});
// Chat icon toggle
const chatIconEl = document.getElementById('chatIcon');
const chatMainContainerEl = document.querySelector('.chat-main-container');

chatIconEl.addEventListener('click', () => {
    chatMainContainerEl.classList.toggle('open');
});
chatIconEl.addEventListener('click', () => {
    if (currentReceiverId) {
        chatMainContainerEl.classList.toggle('open');
    } else {
        alert("Select a user first to start chatting.");
    }
});

document.addEventListener('DOMContentLoaded', () => {
    // --- Configuration and State ---
    const API_BASE_URL = 'http://localhost:3000';
    const CURRENT_USER_ID = localStorage.getItem('currentUserId');
    const CURRENT_USER_NAME = localStorage.getItem('currentUserName');

    let currentReceiverId = null;
    let socket = null;

    // --- Authentication Check ---
    if (!CURRENT_USER_ID || !CURRENT_USER_NAME) {
        alert('Session expired or user data not found. Please log in again.');
        window.location.href = 'login.html';
        return;
    }
    
    // --- DOM Elements ---
    document.getElementById('welcomeHeader').textContent = `Welcome, ${CURRENT_USER_NAME}!`;
    const userListEl = document.getElementById('userList');
    const chatSidebarEl = document.getElementById('chatSidebar');
    const chatRecipientNameEl = document.getElementById('chatRecipientName');
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInputEl = document.getElementById('chatInput');
    const sendBtnEl = document.getElementById('sendBtn');
    const closeChatBtnEl = document.getElementById('closeChat');

    // --- Core Functions ---

    /**
     * Connects to WebSocket server and sets up listeners.
     */
    function connectToSocket() {
        socket = io(API_BASE_URL);

        socket.on('connect', () => {
            console.log('Connected to WebSocket server!');
            // Join a room specific to this user to receive private messages
            socket.emit('join_chat', CURRENT_USER_ID);
        });

        // Listen for new messages from the server
        socket.on('new_message', (message) => {
            // Only display the message if it's part of the currently active chat
            if (message.sender_id == currentReceiverId || message.sender_id == CURRENT_USER_ID) {
                displayMessage(message);
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket server.');
        });
    }

    /**
     * Fetches all users and populates the sidebar list.
     */
    async function fetchAndDisplayUsers() {
        try {
            // FIX: Pass the current user's ID to the backend to exclude them from the list
            const response = await fetch(`${API_BASE_URL}/users?currentUserId=${CURRENT_USER_ID}`);
            if (!response.ok) throw new Error('Failed to fetch users');
            
            const users = await response.json();
            userListEl.innerHTML = ''; // Clear placeholder

            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.innerHTML = `<strong>${user.name}</strong> <span class="role">(${user.role})</span>`;
                li.setAttribute('data-user-id', user.user_id);
                li.addEventListener('click', () => openChat(user.user_id, user.name));
                userListEl.appendChild(li);
            });
        } catch (error) {
            console.error('Failed to fetch user list:', error);
            userListEl.innerHTML = '<li class="user-list-placeholder error">Error loading users.</li>';
        }
    }

    /**
     * Initializes chat with a selected user.
     */
    async function openChat(userId, userName) {
        if (currentReceiverId === userId) return;

        currentReceiverId = userId;

        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`[data-user-id='${userId}']`).classList.add('active');

        chatRecipientNameEl.textContent = `Chat with ${userName}`;
        chatInputEl.disabled = false;
        sendBtnEl.disabled = false;
        chatSidebarEl.classList.add('open');
        chatMessagesEl.innerHTML = ''; 

        // Load historical messages
        await loadMessages();
    }

    /**
     * Fetches and displays historical messages for the current conversation.
     */
    async function loadMessages() {
        if (!currentReceiverId) return;
        try {
            const url = `${API_BASE_URL}/messages/get/${CURRENT_USER_ID}/${currentReceiverId}`;
            const res = await fetch(url);
            const messages = await res.json();
            
            chatMessagesEl.innerHTML = '';
            messages.forEach(displayMessage);
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    /**
     * Appends a single message to the chat window.
     */
    function displayMessage(message) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('chat-message');
        msgDiv.classList.add(message.sender_id == CURRENT_USER_ID ? 'user-message' : 'other-message');
        msgDiv.textContent = message.message_text;
        chatMessagesEl.appendChild(msgDiv);
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    /**
     * Sends a message via API POST request.
     */
    async function sendMessage() {
        const messageText = chatInputEl.value.trim();
        if (messageText === "" || !currentReceiverId) return;

        try {
            const payload = {
                sender_id: parseInt(CURRENT_USER_ID),
                receiver_id: parseInt(currentReceiverId),
                message_text: messageText
            };

            await fetch(`${API_BASE_URL}/messages/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            chatInputEl.value = ''; // Clear input field
            chatInputEl.focus();

        } catch (error) {
            console.error('Network error sending message:', error);
            alert('An error occurred while sending the message.');
        }
    }

    // --- Event Listeners ---
    closeChatBtnEl.addEventListener('click', () => {
        chatSidebarEl.classList.remove('open');
        currentReceiverId = null;
        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
    });

    sendBtnEl.addEventListener('click', sendMessage);
    chatInputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // --- Initialization ---
    fetchAndDisplayUsers();
    connectToSocket();
});

        function showForm() {
  document.getElementById('uploadCard').style.display = 'none';
  document.getElementById('internshipForm').style.display = 'block';
}

function hideForm() {
  document.getElementById('uploadCard').style.display = 'block';
  document.getElementById('internshipForm').style.display = 'none';
}

async function submitInternship(event) {
  event.preventDefault();

  const alumniId = localStorage.getItem("alumniId"); // make sure you store this after alumni login

  const internshipData = {
    alumni_id: alumniId,
    title: document.getElementById('internshipName').value,
    description: document.getElementById('description').value,
    company_name: document.getElementById('companyName').value,
    location: document.getElementById('location').value,
    duration: document.getElementById('duration').value,
    stipend: document.getElementById('salary').value,
    deadline: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0], // auto 1 month deadline
  };

  try {
    const res = await fetch("http://localhost:3000/api/internships", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(internshipData),
    });

    const data = await res.json();

    if (res.ok) {
      document.getElementById('successModal').style.display = 'flex';
      event.target.reset();
    } else {
      alert(data.error || "Failed to post internship");
    }
  } catch (err) {
    console.error(err);
    alert("Server error. Please try again later.");
  }
}

function closeModal() {
  document.getElementById('successModal').style.display = 'none';
  hideForm();
}
</script>
    <footer class="footer">
        <p>&copy; 2025 Alumni Student Management System. All rights reserved.</p>
    </footer>
</body>
</html>